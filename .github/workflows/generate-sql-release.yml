name: Generate SQL Release Bundle

on:
  pull_request:
    branches:
      - Release
    types: [closed]
  workflow_dispatch: # This enables the manual "Run" button

jobs:
  generate-bundle:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # This fetches all branches and history

      - name: Process SQL Changes
        id: process_sql
        shell: bash
        run: |
          # 1. Handle Git History safely
          # Only unshallow if the repo actually is shallow
          if [ -f .git/shallow ]; then
            git fetch --unshallow --tags
          else
            git fetch --all --tags
          fi
          # 1. Find the last release timestamp from the Output folder
          # Format expected: 20260218123000__SomeText.sql
          LAST_FILE=$(ls -1 Output/ | grep '__' | sort -r | head -n 1)

          # Step-by-step check to prevent "ls" errors
          if [ -d "Output" ]; then
              echo "Output directory exists. Checking for files..."
              
              # Capture file list safely
              FILE_LIST=$(ls -1 Output/ 2>/dev/null | grep '__' || true)
              
              if [ -n "$FILE_LIST" ]; then
                  LAST_FILE=$(echo "$FILE_LIST" | sort -r | head -n 1)
                  echo "Found last file: $LAST_FILE"
                  
                  RAW_TS=$(echo "$LAST_FILE" | cut -d'_' -f1)
                  # YYYYMMDDHHMMSS -> YYYY-MM-DD HH:MM:SS
                  LAST_RELEASE_TS="${RAW_TS:0:4}-${RAW_TS:4:2}-${RAW_TS:6:2} ${RAW_TS:8:2}:${RAW_TS:10:2}:${RAW_TS:12:2}"
              fi
          fi
          
          # 2. Set Diff Range
          if [ -z "$LAST_RELEASE_TS" ]; then
              echo "Result: No previous timestamp. Processing all history."
              START_POINT=$(git rev-list --max-parents=0 HEAD)
              DIFF_RANGE="$START_POINT..HEAD"
          else
              echo "Result: Processing changes since $LAST_RELEASE_TS"
              DIFF_RANGE="--since=\"$LAST_RELEASE_TS\""
          fi

          TIMESTAMP=$(date +"%Y%m%d%H%M%S")
          OUTPUT_FILE="Output/${TIMESTAMP}__ReleaseBundle.sql"
          mkdir -p Output

          # 2. Identify changed files
          # Note: We use 'origin/Release' to ensure we see what's on the server
          FILES=$(git log $DIFF_RANGE --name-only --pretty=format: | sort -u)

          # Initialize counters
          SP_COUNT=0
          DATA_COUNT=0
          ERRORS=0

          echo "### SQL Processing Report" >> $GITHUB_STEP_SUMMARY
          echo "| File Type | Status | File Name |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          for FILE in $FILES; do
              # Skip if file doesn't exist (deleted) or isn't in our target folders
              if [ -z "$FILE" ] || [ ! -f "$FILE" ]; then continue; fi
              
              # --- STORED PROCEDURES ---
              if [[ $FILE == *"SP/"* && $FILE == *.sql ]]; then
                  # Clean Windows line endings for reliable regex matching
                  CONTENT=$(cat "$FILE" | tr -d '\r')
                  
                  # Validation for CREATE OR ALTER PROCEDURE
                  if [[ ! "$CONTENT" =~ (GO)?[[:space:]]*CREATE[[:space:]]+OR[[:space:]]+ALTER[[:space:]]+PROCEDURE ]]; then
                      echo "| SP | FAILED | $FILE |" >> $GITHUB_STEP_SUMMARY
                      echo "::error::Validation Failed: $FILE is missing 'CREATE OR ALTER PROCEDURE'."
                      ERRORS=$((ERRORS + 1))
                      continue
                  fi

                  {
                      echo -e "--------\nGO\n--------\n-- $(basename "$FILE")\n--------"
                      echo "$CONTENT"
                      echo -e "\n"
                  } >> "$OUTPUT_FILE"
                  
                  SP_COUNT=$((SP_COUNT + 1))
                  echo "| SP | Added | $FILE |" >> $GITHUB_STEP_SUMMARY

              # --- DATA SCRIPTS (Data/ folder) ---
              elif [[ $FILE == *"Data/"* && $FILE == *.sql ]]; then
                  # Get just the diffs since that timestamp
                  DIFF_CHANGES=$(git log $DIFF_RANGE -p --unified=0 "$FILE" | grep '^[+ ]' | grep -v '+++' | grep -v 'diff --git')
                  
                  if [ -n "$DIFF_CHANGES" ]; then
                      {
                          echo -e "--------\nGO\n--------\n-- $FILE (Diff)\n--------"
                          echo "$DIFF_CHANGES"
                          echo -e "\n"
                      } >> "$OUTPUT_FILE"
                      
                      DATA_COUNT=$((DATA_COUNT + 1))
                      echo "| Data | Diffed | $FILE |" >> $GITHUB_STEP_SUMMARY
                  fi
              fi
          done

          # Final Summary Logic
          echo -e "\n**Processing Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Stored Procedures added: $SP_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Data scripts diffed: $DATA_COUNT" >> $GITHUB_STEP_SUMMARY
          
          if [ $ERRORS -gt 0 ]; then
              echo "- Validation Errors: $ERRORS" >> $GITHUB_STEP_SUMMARY
              echo "Script execution terminated due to validation failure."
              exit 1
          fi

          # Set output variables for use in subsequent steps
          echo "SP_COUNT=$SP_COUNT" >> $GITHUB_OUTPUT
          echo "DATA_COUNT=$DATA_COUNT" >> $GITHUB_OUTPUT

      - name: Commit and Push
        if: success() && (steps.process_sql.outputs.SP_COUNT > 0 || steps.process_sql.outputs.DATA_COUNT > 0)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-generated SQL bundle [SP: ${{ steps.process_sql.outputs.SP_COUNT }}, Data: ${{ steps.process_sql.outputs.DATA_COUNT }}]"
          file_pattern: 'Output/*.sql'